(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{527:function(s,t,a){"use strict";a.r(t);var n=a(6),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("工作上需要 SSR，索性就選擇了 Nuxt 作為開發工具來實現。在部屬上遇到蠻多困難的點與雷，其實是我自己也很久沒碰 Docker 了，就來記錄一下這好用卻不方便的東西吧，希望後面的小夥伴可以順利建置成功。")]),s._v(" "),a("h1",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("相信大家都看到這邊都用 Nuxt 開發的差不多了，來到了最後的步驟-建置與部署。因為團隊需要，所以打算在 Docker 掛一個容器來跑 node 環境並在裡面部署 nuxt，聽起來就很簡單。那我們就開始一步步來做建置吧。Nuxt 部署主要分為兩種模式，一種為靜態部署，另一種為服務端渲染部署。講簡單點，第一種靜態部為靜態網站，把生成好的檔案( html, css, js )全部丟到服務下面就可以跑起來了，而第二種服務端渲染部署就是會在服務端建置 server 來動態的產生各個頁面，也就是 SSR 的部分。這邊主要是講解服務端渲染部署在 Docker 的步驟。")]),s._v(" "),a("h2",{attrs:{id:"打包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#打包"}},[s._v("#")]),s._v(" 打包")]),s._v(" "),a("p",[s._v("當我們網頁差不多完成後，我們可以用 Nuxt 本身提供的指令來完成打包的動作。")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"scripts"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lint"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eslint --ext .js,.vue --ignore-path .gitignore ."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"dev"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cross-env NODE_ENV=development nodemon server/index.js --watch server"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"build"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nuxt build"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"start"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cross-env NODE_ENV=production node server/index.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"generate"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nuxt generate"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("這邊主要會用到 build 和 start ，而其中 generate 會產生所有靜態頁在跟目錄的 dist 資料夾中，並有預渲染所有頁面的優勢，較好的 SEO 與網頁加載 (因為不用透過 server)，但這邊就不介紹這部分的動作了，網上很多相關知識。")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://nuxtjs.org/guide/commands/#%E5%91%BD%E4%BB%A4%E5%88%97%E8%A1%A8",target:"_blank",rel:"noopener noreferrer"}},[s._v("官網"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"https://ithelp.ithome.com.tw/articles/10209553",target:"_blank",rel:"noopener noreferrer"}},[s._v("鐵人好文"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("在部署之前我們需要先建構整個 nuxt 服務端，再啟動他，所以先執行 build 後，會在 .nuxt 資料夾中產生 dist 資料夾，之後再執行 start 就可以再 localhost:3000 下面開啟你的網站了。")]),s._v(" "),a("div",{staticClass:"language-script line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm run build\nnpm run start\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[s._v("注意：執行 start 前需要把當下的 serve 服務關掉。")])]),s._v(" "),a("h2",{attrs:{id:"搬移建置後的需要的檔案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#搬移建置後的需要的檔案"}},[s._v("#")]),s._v(" 搬移建置後的需要的檔案")]),s._v(" "),a("p",[s._v("若伺服器端不想裝原始碼的話，我們可以先執行 npm build，再把產生好的檔案連同需要的指令內容，丟到服務端的指定資料夾下。\n需要的檔案如圖：( dockerfile 等等會介紹 )")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/nZSHxz3.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"dockerfile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile"}},[s._v("#")]),s._v(" dockerfile")]),s._v(" "),a("p",[s._v("依照以上的建置打包的步驟，我們建構自己的 Docker image。(若不懂指令"),a("a",{attrs:{href:"https://ithelp.ithome.com.tw/articles/10191016",target:"_blank",rel:"noopener noreferrer"}},[s._v("鐵人好文"),a("OutboundLink")],1),s._v(")")]),s._v(" "),a("div",{staticClass:"language-dockerfile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 我們的 node 版本 image 的環境")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("10.16.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 創造目標的資料夾")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p /usr/src/my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nuxt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("app\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /usr/src/my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nuxt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("app\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把當下資料夾內容複製到容器內的指定的資料夾底下 (若有 dockerignore 會忽略指定的內容)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . /usr/src/my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nuxt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("app/\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安裝所有套件並建置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 若 你是整包原始碼裝過來的話，請設定 .dockerignore 並加上下一行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# RUN npm build")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把容器對外的 port 開啟")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3000\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 容器內 我們 nuxt 的 host 和 port 指定給環境變數")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" NUXT_HOST=0.0.0.0\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" NUXT_PORT=3000\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 執行鏡像時會執行的 script")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"npm"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"start"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("我們的 dockerfile 完成後就來創造這個 image (名稱自取，中括號都可以自由填寫)：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Docker build -t "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("image 名稱"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("創造完這個 image 後，就可以開啟一個容器來執行了。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Docker run --name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("容器名稱"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" -dt -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v(":3000 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("image 名稱"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("因為 nuxt 是設定在 port 3000 執行，所以我們把容器的 port 3000 印射到本機的 port 8081。接下來我們就可以再 localhost:8081 下訪問到網站了。 (image 名稱要一樣喔)")]),s._v(" "),a("h3",{attrs:{id:"dockerignore"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dockerignore"}},[s._v("#")]),s._v(" dockerignore")]),s._v(" "),a("p",[s._v("若是整包程式碼搬過來，例如 git clone，則要設定 .dockerignore 內容。(不設定也沒差啦，只是這樣跑比較快一點)")]),s._v(" "),a("div",{staticClass:"language-dockerfile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[s._v("node_modules\nnpm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("debug*\n.nuxt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"踩過的坑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#踩過的坑"}},[s._v("#")]),s._v(" 踩過的坑")]),s._v(" "),a("ol",[a("li",[s._v("容器內的 node 的版本要裝對。")]),s._v(" "),a("li",[s._v("ENV NUXT_HOST=0.0.0.0 和 ENV NUXT_PORT=3000 環境變數記得指定。")])]),s._v(" "),a("h3",{attrs:{id:"結論"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#結論"}},[s._v("#")]),s._v(" 結論")]),s._v(" "),a("p",[s._v("部署到 Docker 是方便測試人員和其他非技術人員可以先看到網站，主要是給 UX/UI 來看看是否符合設計標準，以及功能是否正常，並不能當作對外的連線。大概有一年沒有碰到後端需要做設定的部分了，若有不明白的地方請多多指教。")]),s._v(" "),a("h5",{attrs:{id:"來源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#來源"}},[s._v("#")]),s._v(" 來源：")]),s._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://jonathanmh.com/deploying-a-nuxt-js-app-with-Docker/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Deploying a Nuxt.js App with Docker"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);